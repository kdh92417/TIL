# 9. DML: 서브쿼리

## 1. Subquery

> SQL 문 (주로 SELECT 문) 안에 포함되는 SELECT 문.

- 메인쿼리
- 서브쿼리

### 1.1 컬럼 참조의 제한

일반적으로 서브쿼리는 메인쿼리의 컬럼을 참조할 수 있지만, 메인쿼리는 서브쿼리의 컬럼을 참조할 수 없다.
- 단 Inline View(FROM절 서브쿼리)의 경우, 메인 쿼리는 Inline View의 컬럼을 자유롭게 참조 가능

### 1.2 Example

```mysql
SELECT a, b 
FROM 메인테이블 X
WHERE X.a = Y.a  /* Error : 서브쿼리는 메인쿼리에서 참조할 수 없다. */
    AND EXISTS(
        SELECT a, b 
        FROM 서브테이블 Y
        WHERE Y.a = X.a  /* 메인쿼리는 서브쿼리에서 참조할 수 있다. */
    );
```

### 1.3 ORDER BY 절 사용의 제한
- WHERE 절 서브쿼리에서는 ORDER BY 절을 사용하지 못한다.

<br>

## 2. WHERE 절 서브쿼리

### 2.1 반환되는 결과의 형태에 따른 분류 (연산자에 따른 분류)

- 단일값 서브쿼리 (scalar subquery) : 단일값 비교연산자(`=`, `<>`, `<`, `<=`, `>=`)
- 다중값 서브쿼리 (column subquery) : 단일값 비교연산자(`=`, `<>`, `<`, `<=`, `>=`), 한정자(`ANY`, `SOME`, `ALL`)
- 다중행 서브쿼리 (table subquery) : 멤버쉽 연산자(`IN`), 존재 정량자(`EXISTS`)
  - EXISTS: 서브쿼리의 결과를 만족하는 투플의 존재여부 확인, 존재를 확인하는 투플을 1개라도 찾는다면 검색을 멈춘다.

<br>

### 2.2 동작하는 방식에 따른 분류
- 비연관 서브쿼리
  - 서브쿼리가 메인쿼리 컬럼을 가지고 있지 않은 형태
  - 서브쿼리는 한번 실행
  - 메인쿼리에 서브쿼리 결과를 제공

- 연관 서브쿼리
  - 서브쿼리가 메인쿼리 컬럼을 가지고 있는 형태
  - 메인쿼리의 투플마다 서브쿼리가 반복 실행(nested loop와 유사)
  - 메인쿼리 테이블을 필터링
  
<br>

### 2.3 연관 서브쿼리와 조인의 차이

> 결과 테이블의 형태와 튜플 개수에서 차이가 있다.

조인의 경우
- 조인하는 두테이블의 컬럼이 모두 포함
- 결과 테이블의 최대 수는 양쪽 테이블 m * n의 값이다.

연관 서브쿼리를 포함한 메인쿼리의 경우
- 메인쿼리 테이블의 부분집합을 리턴(결과 테이블의 컬럼은 메인쿼리 컬럼만 포함 된다.)
- 결과 테이블의 최대 수는 메인쿼리의 수 m의 값

<br>

### 2.4 출력가능한 컬럼

- 연관 서브쿼리를 포함한 메인쿼리의 SELECT 절에는 서브쿼리의 테이블컬럼을 사용할 수없다.
- 반대로 서브쿼리에서는 메인쿼리의 컬럼이 사용 가능하다.
    ```mysql
    SELECT A, B
    FROM a_products
    WHERE a_products.A IN (
                            SELECT A
                            FROM b_products
                            WHERE a_products.A = 3 /* 메인쿼리의 컬럼 사용 가능 */
                          )           
    ```

<br>

## 3. WHERE 절 이외의 서브쿼리

### 3.1 SCALAR SUBQUERY (SELECT 절 서브쿼리)

- 새로운 컬럼 생성
- 단일값 서브쿼리만 사용 가능 (주로 집단 함수를 이용한 통계 단일값)

```mysql
SELECT A
     , (SELECT AVG(A) FROM products) /* 집단 함수를 이용한 통계 단일 값 */
FROM products
```

<br>

### 3.2 Inline View (FROM 절 서브쿼리)

- 임시 테이블 생성
- 서브쿼리의 결과를 동적으로 생성한 테이블인 것처럼 사용
- DB에 해당 테이블이 저장되지 않는다.
- WITH 절과 상호호환 가능


**Inline View와 WHERE 절 서브쿼리의 차이**

- 메인쿼리에서 Inline View에 컬럼을 참조할 수 있다. (다른 서브쿼리에서는 불가)
- ORDER BY 절 사용가능 (다른 서브쿼리에서는 사용불가)


```mysql
SELECT c, d, e
FROM (
        SELECT c, d, e
        FROM products
     ) AS P /* MySQL에서의 Inline View는 Table Alias를 명시해줘야됨 */
```

<br>

## 4. 각 절에 따른 서브쿼리의 용도

### WHERE 절 서브쿼리

- 테이블필터로서의 사용(메인쿼리테이블에 있는 투플을 필터링)

### SELECT 절 서브쿼리

- 새로운 컬럼을 생성 (주로 집단함수를 이용한 단일값 생성)

### FROM 절 서브쿼리

- 임시 테이블 생성 (WITH 절의 역할과 동일)
